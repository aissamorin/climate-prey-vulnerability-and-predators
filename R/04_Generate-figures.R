
###### Generating figures from the results of the model ####


###################################### DESCRIPTION ############################################################### ##########################################################################



# This script allows to represent the main results of the paper along with the figure S2 from the Appendix A of the supplementary Material. For each: 
#Firstly, the code allows to represent the subfigure for the immediate response of predator populations to specific rainfall condition, i.e. the predator population growth rate as a function of predetermined value of rainfall.
#Secondly, the code allows to represent the subfigure for the long-term response of predator populations to changes in mean annual rainfall, i.e. the predator mean population size as a function of rainfall.



###########################################################################################################################################################




### Necessary Packages ####

# If not already installed 

require(reshape2) # version 2_1.4.4
require(ggplot2) # version 3.3.2
require(cowplot) # version 1.0.0 
require(gridExtra) # version 2.3
require(RColorBrewer)# version 1.1-2  




#--------------------------------------------------------------------------------------------------------------------------------------

######################################### MAIN RESULTS (Figure 4) ###############################################


##### Panel A : Immediate response of predator population to specific rainfall condition #####
# Predator population growth rate as a function of predetermined value of rainfall (called RESFOR)

###> Data  #####

results4 <- read.csv2("./output/Sim_ShortTerm_Defaultpar_HuntingSuccesspositive_z1000_t200.csv", dec = ".") # File 


####>> Subset according to scenario #####

Scenario1_4 <- subset(results4, Scenario == 1)
Scenario2_4 <- subset(results4, Scenario == 2)
Scenario3_4 <- subset(results4, Scenario == 3)
Scenario4_4 <- subset(results4, Scenario == 4)

####>> Table ####

r_growthR <- as.data.frame(cbind(Scenario1_4$Resfor, Scenario1_4$Lbdfin, Scenario2_4$Lbdfin, Scenario3_4$Lbdfin, Scenario4_4$Lbdfin))
names(r_growthR) <- c('Resfor', 'Scenario1', 'Scenario2', 'Scenario3', 'Scenario4')
r_growthR_2 <- melt(r_growthR, id.vars = 'Resfor', measure.vars = c('Scenario1', 'Scenario2', 'Scenario3', 'Scenario4'))


####>> Table for minimum and maximum values (envelop) ####

Agg_r_growthR2_min <- aggregate(value~Resfor + variable, data = r_growthR_2, FUN = min)
Agg_r_growthR2_max <- aggregate(value~Resfor + variable, data = r_growthR_2, FUN = max)
Agg_r_growthR2 <- merge(Agg_r_growthR2_min, Agg_r_growthR2_max, by = c("Resfor","variable"))
colnames(Agg_r_growthR2)[c(3,4)] <- c ("min", "max")


###> Figure ####

###>> Color palette ###

brewer.pal(10, name = "Paired")
lbls <- c('Scenario1', 'Scenario2', 'Scenario3','Scenario4')
vec_color <- c("#7570b3", "#1b9e77", "#d95f02", "#e7298a")

####>> Plot  ####

g1 <- ggplot(r_growthR_2) +
  geom_smooth(aes(x = Resfor, y = value, col = variable), se = FALSE, span = 0.5, size = 1, method = "loess")+
  geom_ribbon(data = Agg_r_growthR2, aes(x= Resfor, ymin = min, ymax = max, fill = variable),alpha = 0.075, show.legend = TRUE) +
  theme_bw(base_line_size = 0.9,
           base_rect_size = 1)+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        axis.text = element_text(size = 13,colour = "black"),
        axis.title.y = element_text(size = 15,margin = margin(0, 10, 0, 0)),
        axis.title.x = element_text(size = 15, margin = margin(10, 0, 10, 0)),
        legend.position = "bottom", 
        legend.text = element_text(size = 12,margin = margin(10, 0, 0, 0)),
        plot.margin = unit(c(0, 0.1, 0, 0.2), "cm")) +
  scale_colour_manual(name = "",
                      values = setNames(vec_color,lbls)) +
  scale_fill_manual(name = "",
                    values = setNames(vec_color,lbls)) +
  scale_x_continuous(breaks = c(300, 400, 500, 600, 700, 800, 900),
                     labels = c(300, 400, 500, 600, 700, 800, 900))+
  labs(x = "Specific rainfall condition (mm)",
       y = "Predator growth rate") +
  ylim(c(0.6, 1.5))


##### Panel B : Long term response of predator populations to changes in mean annual rainfall ####
# Predator mean population size as a function of rainfall

###> Data  #####

results2 <- read.csv2('./output/Sim_LongTerm_Defaultpar_HuntingSuccesspositive_z1000_t201.csv', dec='.') # File 

####>> Subset according to scenario #####

Scenario1 <- subset(results2, Scenario == 1)
Scenario2 <- subset(results2, Scenario == 2)
Scenario3 <- subset(results2, Scenario == 3)
Scenario4 <- subset(results2, Scenario == 4)

####>> Table ####

Rmean_1 <- as.data.frame(cbind(Scenario1$ResTh, Scenario1$Meanpred, Scenario2$Meanpred, Scenario3$Meanpred, Scenario4$Meanpred))
names(Rmean_1) <- c('ResTh', 'Scenario1', 'Scenario2', 'Scenario3', 'Scenario4')

Rmean_2 <- melt(Rmean_1, id.vars='ResTh', measure.vars = c('Scenario1', 'Scenario2', 'Scenario3','Scenario4'))

####>> Table for minimum and maximum values (envelop) ####

Agg_R_mean2_min <- aggregate(value~ResTh + variable, data=Rmean_2, FUN = min)
Agg_R_mean2_max <- aggregate(value~ResTh + variable, data=Rmean_2, FUN = max)
Agg_R_mean2 <- merge(Agg_R_mean2_min, Agg_R_mean2_max, by = c("ResTh","variable"))
colnames(Agg_R_mean2)[c(3,4)] <- c ("min", "max")

###> Figure ####

###>> Color palette ###

brewer.pal(10, name = "Paired")
lbls <- c('Scenario1', 'Scenario2', 'Scenario3','Scenario4')
vec_color <- c("#7570b3", "#1b9e77", "#d95f02", "#e7298a")

####>> Plot ####

g2 <- ggplot(Rmean_2) +
  geom_smooth(aes(x = ResTh, y = value, col = variable),span = 0.5, se = FALSE, size = 1, method = "loess") +
  geom_ribbon(data = Agg_R_mean2, aes(x = ResTh, ymin = min, ymax = max, fill = variable), alpha = 0.1, show.legend = T) +
  theme_bw(base_line_size = 0.9,
           base_rect_size = 1)+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        axis.text = element_text(size = 13, colour = "black"),
        axis.title.y  = element_text(size = 15, margin = margin(0, 10, 0, 0)),
        axis.title.x = element_text(size = 15,margin = margin(10, 0, 10, 0)),
        legend.position = "none", 
        legend.text = element_text(size = 12, margin = margin(10, 0, 0, 0)),
        plot.margin = unit(c(0, 0.1, 0, 0.2), "cm")) +
  scale_colour_manual(name = "",
                      values = setNames(vec_color, lbls)) +
  scale_fill_manual(name = "",
                    values = setNames(vec_color, lbls)) +
  scale_x_continuous(breaks = c(300, 400, 500, 600, 700, 800, 900), 
                     labels = c(300, 400, 500, 600, 700, 800, 900)) +
  labs(x = "Mean annual rainfall (mm)",
       y = "Predator population size")

####> Assembling subfigures ####

legend <- get_legend(g1)
g1 <- g1 + theme(legend.position = "none") 

g3 <- plot_grid(g1, g2,  align = "v",axis ='top', ncol = 1,  rel_heights = c(0.50, 0.50))
g4 <- plot_grid(g3, legend,  nrow = 2,  rel_heights = c(0.95, 0.07))

g4 <- ggdraw(g4) +
  draw_label('A', x = 0.14, y = 0.955, size = 15) +
  draw_label('B', x = 0.14, y = 0.49, size = 15) 

###> Save main results #####

ggsave("./figs/Fig_4.TIFF", dpi = 600, g4, height = 30, width = 18, units = "cm") 

ggsave("./figs/Fig_4.jpg", dpi = 600, g4, height = 30, width = 18, units = "cm") 







#--------------------------------------------------------------------------------------------------------------------########################################################################################################################
#---------------------------------------------------------------------------------------------------------------------#






######### SUPPLEMENTARY MATERIAL - APPENDIX A (Figure S2) ###########

# Responses of predator populations to an increase in rainfall when habitat driven hunting success decreases with rainfall i.e. when h - handling time - varies positively with rainfall


##### Panel A : Immediate response of predator population to specific rainfall condition #####
# Predator population growth rate as a function of predetermined value of rainfall (called RESFOR)

###> Data  #####

results5 <- read.csv2("./output/Sim_ShortTerm_Defaultpar_HuntingSuccessnegative_z1000_t200.csv", dec = ".") # File 

####>> Subset according to scenario #####

Scenario1_5 <- subset(results5, Scenario == 1)
Scenario2_5 <- subset(results5, Scenario == 2)
Scenario3_5 <- subset(results5, Scenario == 3)
Scenario4_5 <- subset(results5, Scenario == 4)

####>> Table ####

r_growthR_3 <- as.data.frame(cbind(Scenario1_5$Resfor, Scenario1_5$Lbdfin, Scenario2_5$Lbdfin, Scenario3_5$Lbdfin, Scenario4_5$Lbdfin))
names(r_growthR_3) <- c('Resfor', 'Scenario1', 'Scenario2', 'Scenario3', 'Scenario4')

r_growthR_4 <- melt(r_growthR_3, id.vars = 'Resfor', measure.vars = c('Scenario1', 'Scenario2', 'Scenario3', 'Scenario4'))


####>> Table for minimum and maximum values (envelop) ####

Agg_r_growthR4_min <- aggregate(value~Resfor + variable, data = r_growthR_4, FUN = min)
Agg_r_growthR4_max <- aggregate(value~Resfor + variable, data = r_growthR_4, FUN = max)
Agg_r_growthR4 <- merge(Agg_r_growthR4_min, Agg_r_growthR4_max, by = c("Resfor", "variable"))
colnames(Agg_r_growthR4)[c(3,4)] <- c ("min", "max")

###> Figure ####

###>> Color palette ###

brewer.pal(10, name = "Paired")
lbls <- c('Scenario1', 'Scenario2', 'Scenario3', 'Scenario4')
vec_color<-c("#7570b3", "#1b9e77", "#d95f02", "#e7298a")


####>> Plot ####

g5 <- ggplot(r_growthR_4) +
  geom_smooth(aes( x= Resfor, y = value, col = variable), se = FALSE, span = 0.5, size = 1, method = "loess") + 
  geom_ribbon(data = Agg_r_growthR4, aes(x = Resfor, ymin = min, ymax = max, fill = variable), alpha = 0.075, show.legend = TRUE) +
  theme_bw(base_line_size = 0.9,
           base_rect_size = 1)+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        axis.text = element_text(size = 13,colour = "black"),
        axis.title.y = element_text(size = 15,margin = margin(0, 10, 0, 0)),
        axis.title.x = element_text(size = 15, margin = margin(10, 0, 10, 0)),
        legend.position = "bottom", 
        legend.text = element_text(size = 12,margin = margin(10, 0, 0, 0)),
        plot.margin = unit(c(0, 0.1, 0, 0.2), "cm")) +
  scale_colour_manual(name = "",
                      values = setNames(vec_color,lbls)) +
  scale_fill_manual(name = "",
                    values = setNames(vec_color,lbls)) +
  scale_x_continuous(breaks = c(300, 400, 500, 600, 700, 800, 900),
                     labels = c(300, 400, 500, 600, 700, 800, 900))+
  labs(x = "Specific rainfall condition (mm)",
       y = "Predator growth rate") +
  ylim(c(0.6, 1.5))



##### Panel B : Long term response of predator populations to changes in mean annual rainfall ####
# Predator mean population size as a function of rainfall


###> Data  #####

results3 <- read.csv2('./output/Sim_LongTerm_Defaultpar_HuntingSuccessnegative_z1000_t201.csv', dec = '.') # File 

####>> Subset according to scenario #####

Scenario1_3 <- subset(results3, Scenario == 1)
Scenario2_3 <- subset(results3, Scenario == 2)
Scenario3_3 <- subset(results3, Scenario == 3)
Scenario4_3 <- subset(results3, Scenario == 4)

####>> Table ####

Rmean_3 <- as.data.frame(cbind(Scenario1_3$ResTh, Scenario1_3$Meanpred, Scenario2_3$Meanpred, Scenario3_3$Meanpred, Scenario4_3$Meanpred))
names(Rmean_3) <- c('ResTh', 'Scenario1', 'Scenario2', 'Scenario3', 'Scenario4')

Rmean_4 <- melt(Rmean_3, id.vars = 'ResTh', measure.vars= c('Scenario1', 'Scenario2', 'Scenario3', 'Scenario4'))

####>> Table for minimum and maximum values (envelop) ####

Agg_R_mean3_min <- aggregate(value~ResTh + variable, data = Rmean_4, FUN = min)
Agg_R_mean3_max <- aggregate(value~ResTh + variable, data = Rmean_4, FUN = max)
Agg_R_mean3 <- merge(Agg_R_mean3_min, Agg_R_mean3_max, by = c("ResTh","variable"))
colnames(Agg_R_mean3)[c(3,4)] <- c ("min", "max")

###> Figure ####

###>> Color palette ###

brewer.pal(10, name = "Paired")
lbls <- c('Scenario1', 'Scenario2', 'Scenario3', 'Scenario4')
vec_color <- c("#7570b3", "#1b9e77", "#d95f02", "#e7298a")

####>> Plot  ####

g6 <- ggplot(Rmean_4) +
  geom_smooth(aes(x = ResTh, y = value, col = variable), se = FALSE, span =0.5, size = 1, method = "loess") +
  geom_ribbon(data = Agg_R_mean3, aes(x = ResTh, ymin = min, ymax = max, fill = variable),alpha = 0.1, show.legend = T) +
  theme_bw(base_line_size = 0.9,
           base_rect_size = 1)+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        axis.text = element_text(size = 13, colour = "black"),
        axis.title.y  = element_text(size = 15, margin = margin(0, 10, 0, 0)),
        axis.title.x = element_text(size = 15,margin = margin(10, 0, 10, 0)),
        legend.position = "none", 
        legend.text = element_text(size = 12, margin = margin(10, 0, 0, 0)),
        plot.margin = unit(c(0, 0.1, 0, 0.2), "cm")) +
  scale_colour_manual(name = "",
                      values = setNames(vec_color, lbls)) +
  scale_fill_manual(name = "",
                    values = setNames(vec_color, lbls)) +
  scale_x_continuous(breaks = c(300, 400, 500, 600, 700, 800, 900), 
                     labels = c(300, 400, 500, 600, 700, 800, 900)) +
  labs(x = "Mean annual rainfall (mm)",
       y = "Predator population size")

####> Assembling subfigures ####

legend <- get_legend(g5)
g5 <- g5 + theme(legend.position = "none") 

g7 <- plot_grid(g5, g6,  align = "v",axis ='top', ncol = 1,  rel_heights = c(0.50, 0.50))
g8 <- plot_grid(g7, legend,  nrow = 2,  rel_heights = c(0.95, 0.07))

g8 <- ggdraw(g8) +
  draw_label('A', x = 0.14, y = 0.955, size = 15) +
  draw_label('B', x = 0.14, y = 0.49, size = 15) 

####> Save figure #### 

ggsave("./figs/Fig_S2.TIFF", dpi = 600, g8, height = 30, width = 18, units = "cm") 

ggsave("./figs/Fig_S2.jpg", dpi = 600, g8, height = 30, width = 18, units = "cm") 
