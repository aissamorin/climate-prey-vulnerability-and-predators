

##### Function for the simulation of the long-term response of predator populations to changes in mean annual rainfall ####



#### DESCRIPTION ########################################################################################################################################


# This script displays the code for the simulation for the long-term response of predator populations to changes in mean annual rainfall. 


#########################################################################################################################################################




### Function ####




Sim_LongTerm <- function(t=201, z= 1000, HuntingSuccess= NULL, dir1=".", dir2="./", dorawdata=FALSE ) { # Start function 

  

  ### Default parameters to see how the simulation function works   =================================================================================
  
  
  
  # t = 201 # Number of time steps, set to 201 because of the model construction: some variables are calculated at the time step t+1, if it is not take into account, those variables won't have values at the time t = 200
  # z = 2 # number of simulations (default = 1000)
  # HuntingSuccess = "positive" #  Functional relationship between rainfall and predator habitat-driven hunting success
  # dir1 = "."  # Directory where the source files can be found
  # dir2 = "./"  # Directory where the simulation output files should be saved
  # dorawdata = FALSE  # TRUE if you want the raw data, FALSE otherwise
  
  
  
  
#========================================================================================================================================================
   
  
   
   
#Package

library(plyr) # Version 1.8.6
  

###  Call model ###

setwd(dir1) 
source("R/01_predator-prey_model_2019.R")  # The predator-prey model 




### Prey and predation parameters ====================================================================================================================



# Prey parameters (default values) 

parPrey <- list(
  Pa = 0.95, # Maximum adult prey survival probability
  sdPa = 0.05, # Standard deviation, variation of adult prey survival
  Pj = 0.8, # Maximum juvenile prey survival probability
  sdPj = 0.05, # Standard deviation, variation of juvenile prey survival
  pa_hs = 30, # Adult half-saturation, point at which adult prey survival is lowered by half
  pa_delta = 2, # Shape parameter, defines the onset of density-dependence for adult prey
  pj_hs = 20, # Juvenile half saturation, point at which juvenile prey survival is lowered by half
  pj_delta = 2, # Shape parameter, defines the onset of density-dependence for juvenile prey
  f_low = 100, # Value determining fecundity value when adult survival is close from 0
  f_growth = 15) # Rate at which fecundity value reaches 1 

# Predation parameters (default values) 

# Scenario 1

parPredS1 <- list(  
  uc = 0.0002, # Encounter rate
  hc = 5, # Handling time 
  lambdamax = 1.8, # Predator maximum growth rate
  th_ext = 0, #  Threshold below which predator population become extinct 
  th_pa = 1, # Prey threshold of survival probability below which predators can catch and consume the prey
  scal = 0.3, # Interference between predators in the predator functional response
  h_min = 5) #Lowest value that can be taken by the handling time across all scenarios


# Scenario 2

parPredS2 <- list(  
  uc = 0.0002, 
  hc = 5, 
  lambdamax = 1.8, 
  th_ext = 0, 
  th_pa = 0.5, 
  scal = 0.3, 
  h_min = 5)

# Scenario 3

parPredS3 <- list(  
  uc = 0.0002,  
  hc = NULL, # Here the Handling time is set to be NULL because it will vary in each time steps and will be generated by the model 
  lambdamax = 1.8, 
  th_ext = 0,    
  th_pa = 1, 
  scal = 0.3,
  h_min = 5)

# Scenario 4

parPredS4 <- list(  
  uc = 0.0002, 
  hc = NULL, # Here the Handling time is set to be NULL because it will vary in each time steps and will be generated by the model 
  lambdamax = 1.8, 
  th_ext = 0, 
  th_pa = 0.5,
  scal = 0.3,
  h_min = 5)


# Parameters to calculate the handling time when the hanlding time (and hunting success) varies with rainfall

list_h <- list(A = 5, # Lowest value that can be taken by the handling time across all scenarios
             K = 8, # Highest value that can be taken by the handling time across all scenarios
             B = 0.015, # Maximum rate of change of the handling time
             M = 600) # Rainfall value for which the rate of change of the handling time is maximum (or inflexion point)





####  Initialisation ===============================================================================================================================



  ### Table for storing the outcomes of the simulation  #### 



results <- data.frame (Simulation = numeric(), # Number of simulations
                     Pa = numeric(), # Maximum adult prey survival probability
                     SdPa = numeric(), # Standard deviation, variation of adult prey survival
                     Pj = numeric(), # Maximum juvenile prey survival probability 
                     SdPj = numeric(), # Standard deviation, variation of juvenile prey survival
                     Pa_hs = numeric(), # Adult half-saturation, point at which adult prey survival is lowered by half
                     Pa_delta = numeric(), # Shape parameter, defines the onset of density-dependence for adult prey
                     Pj_hs = numeric(), # Juvenile half saturation, point at which juvenile prey survival is lowered by half
                     Pj_delta = numeric(), # Shape parameter, defines the onset of density-dependence for juvenile prey
                     F_low = numeric(), # Value determining fecundity value when adult survival is close from 0
                     F_growth = numeric(), # Rate at which fecundity value reaches 1
                     Uc = numeric(), # Encounter rate in the predator functional response
                     Hc = numeric (), # Predator handling time for one prey in the predator functional response
                     Lbdmax = numeric(), # Predator maximum growth rate
                     Th_ext = numeric(), # Threshold below which predator population become extinct 
                     Scal = numeric(), # Interference between predators in the predator functional response
                     Time = numeric(), # Time step (within the simulation)
                     Res = numeric(), # Rainfall value calculated for the year
                     ResTh = numeric(), # Mean value of rainfall for the ith simulation 
                     SdTh = numeric(), # Standard deviation value of rainfall for the ith simulations 
                     Scenario = numeric(), # Scenario
                     Th_pa = numeric(), # Prey threshold of survival probability below which predators can catch and consume the prey.
                     H_min = numeric(), # Lowest value that can be taken by the handling time across all scenarios
                     propMmax = numeric(),# To store P_rel values 
                     Size = numeric(), # Model outcome : Prey population size at each time step
                     Pred = numeric(), # Model outcome : Predator population size at each time step
                     Pad  =numeric(), # Model outcome : Proportion of vulnerable adult prey at each time step
                     A = numeric(), # Model outcome : Number of adult prey
                     J = numeric(), # Model outcome : Number of juveniles prey
                     Ratio = numeric(), # Ratio J/A
                     Mortality = numeric()) # Model outcome : Mortality values at each time step



# Generating rainfall data #### 


# Table containing mean/standard deviation pairs used to calculate rainfall for a given year

D <- as.data.frame(cbind(c(seq(300, 900, by = 100)), c(rep(90, 7)))) 
names(D) <- c("res1", "sd1")


resmat <- vector("list", nrow(D)) # To store rainfall values for each time step

for (j in 1:nrow(D)) { 
  resall <- rep(D$res1[j], t*z)
  resmat[[j]] <- matrix(resall, t, z)
}

# To store model outcomes

out.scenario0 <- vector("list", z) # Prey model: Model without predators
out.scenario2 <- vector("list", z) # Scenario 1: Climatic conditions influence predator-prey interactions only through their influence on prey survival and fecundity, i.e. through prey abundance only
out.scenario1 <- vector("list", z) # Scenario 2: Prey vulnerability is affected by climatic conditions through their influence on prey body condition 
out.scenario3 <- vector("list", z) # Scenario 3: Prey vulnerability is affected by climatic conditions through climate-driven changes in habitat characteristics 
out.scenario4 <- vector("list", z) # Scenario 4: Prey vulnerability is affected by both prey body condition and climate-driven changes in habitat characteristics




  ##### SIMULATIONS  ==================================================================================================================================
  


  
 for (a in 1:nrow(D)) { # where "nrwow(D)" is the number of mean/standard deviation pairs to be tested 
    
     print(paste("a:",a))
   

    
    for(i in 1:z) { # z simulations will be run for each mean/standard deviation pairs  
     
      
      print(paste("i:",i))
      
      
      ### MODEL RUN ####
      
      ##### Prey model i.e. model without predators ####

      out.scenario0[[i]] <- model(resDyn = resmat[[a]][,i], # Rainfall values corresponding to the ath mean/standard deviation pair and the ith simulation
                              prey0 = c(2500,7500), # Initial number of prey (juveniles and adults)
                              pred0 = 0, # Model without predators
                              parPrey = parPrey, # List containing prey parameters
                              parPred = NULL, # Model without predators
                              predDyn = TRUE,
                              list_h = NULL, # Model without predators
                              Scenario = 0,
                              HuntingSuccess=HuntingSuccess) # Whether the hunting success varies positively or negatively with rainfall 
      
      ##### Scenario 1 #####
      
      
      out.scenario1[[i]] <- model(resDyn = resmat[[a]][,i], # Rainfall values corresponding to the ath mean/standard deviation pair and the ith simulation
                                 prey0 = c(2500,7500), # Initial number of prey (juveniles and adults)
                                 pred0 = 10,  # Initial number of predators 
                                 parPrey = parPrey, # List containing prey parameters
                                 parPred = parPredS1, # List containing predation parameters
                                 predDyn = TRUE,
                                 list_h = NULL, # The handling time does not vary with rainfall 
                                 Scenario = 1,
                                 HuntingSuccess = HuntingSuccess) # Whether the hunting success varies positively or negatively with rainfall 
      
      #### Scenario 2 #####
      
      out.scenario2[[i]] <- model(resDyn = resmat[[a]][,i],
                             prey0 = c(2500,7500),
                             pred0 = 10,
                             parPrey = parPrey,
                             parPred = parPredS2,
                             predDyn = TRUE,
                             list_h = NULL,
                             Scenario = 2,
                             HuntingSuccess = HuntingSuccess) 
      
      
      #### Scenario 3 ####
      
      out.scenario3[[i]] <- model(resDyn = resmat[[a]][,i],
                              prey0 = c(2500,7500),
                              pred0 = 10,
                              parPrey = parPrey,
                              parPred = parPredS3,
                              predDyn = TRUE,
                              list_h = list_h, # List containing parameters for calulcating the handling time because in this scenario the handling time varies with rainfall 
                              Scenario = 3,
                              HuntingSuccess = HuntingSuccess)
      
      #### Scenario 4 ##### 
      
      out.scenario4[[i]] <- model(resDyn = resmat[[a]][,i],
                                 prey0 = c(2500,7500),
                                 pred0 = 10,
                                 parPrey = parPrey,
                                 parPred = parPredS4,
                                 predDyn = TRUE,
                                 list_h = list_h, # List containing parameters for calulcating the hadling time because in this scenario the handling time varies with rainfall 
                                 Scenario = 4,
                                 HuntingSuccess = HuntingSuccess)
      
      
      
      
      #### Organizing results ####
      # NB: we only store the years 180th to 200th for each simulation
      
      results<-rbind(results,
                      
                     # S0
                      data.frame(Simulation = rep(i,21),
                                 Pa = rep(parPrey[[1]],21), 
                                 SdPa = rep(parPrey[[2]],21), 
                                 Pj = rep(parPrey[[3]],21),
                                 SdPj = rep(parPrey[[4]],21),
                                 Pa_hs = rep(parPrey[[5]],21),
                                 Pa_delta = rep(parPrey[[6]],21),
                                 Pj_hs = rep(parPrey[[7]],21),
                                 Pj_delta = rep(parPrey[[8]],21),
                                 F_low = rep(parPrey[[9]],21), 
                                 F_growth = rep(parPrey[[10]],21), 
                                 Uc = rep(NA, 21),
                                 Hc = rep(NA, 21), 
                                 Lbdmax = rep(NA, 21),
                                 Th_ext = rep(NA, 21),
                                 Scal = rep(NA,21),
                                 Time = 180:200,
                                 Res = resmat[[a]][180:200,i],
                                 ResTh = D$res1[a],
                                 SdTh = D$sd1[a],
                                 Scenario = as.data.frame(out.scenario0[[i]])$Scenario_t[180:200],
                                 Th_pa = rep(NA, 21),
                                 H_min = rep(NA, 21),
                                 propMmax = as.data.frame(out.scenario0[[i]])$propMmax[180:200],
                                 Size = as.data.frame(out.scenario0[[i]])$N[180:200],
                                 Pred = as.data.frame(out.scenario0[[i]])$y[180:200],
                                 Pad = as.data.frame(out.scenario0[[i]])$a_vuln[180:200],
                                 A = as.data.frame(out.scenario0[[i]])$A[180:200],
                                 J =as.data.frame(out.scenario0[[i]])$J[180:200],
                                 Ratio = as.data.frame(out.scenario0[[i]])$J[180:200]/as.data.frame(out.scenario0[[i]])$A[180:200],
                                 Mortality = as.data.frame(out.scenario0[[i]])$m[180:200]),
                      # S1
                     
                     data.frame (Simulation = rep (i,21),
                                 Pa = rep(parPrey[[1]],21), 
                                 SdPa = rep(parPrey[[2]],21), 
                                 Pj = rep(parPrey[[3]],21),
                                 SdPj = rep(parPrey[[4]],21),
                                 Pa_hs = rep(parPrey[[5]],21),
                                 Pa_delta = rep(parPrey[[6]],21),
                                 Pj_hs = rep(parPrey[[7]],21),
                                 Pj_delta = rep(parPrey[[8]],21),
                                 F_low = rep(parPrey[[9]],21), 
                                 F_growth = rep(parPrey[[10]],21), 
                                 Uc = rep(parPredS1[[1]], 21),
                                 Hc = rep(parPredS1[[2]], 21), 
                                 Lbdmax = rep(parPredS1[[3]], 21), 
                                 Th_ext = rep(parPredS1[[4]], 21),
                                 Scal = rep(parPredS1[[6]],21),
                                 Time = 180:200,
                                 Res = resmat[[a]][180:200,i],
                                 ResTh = D$res1[a],
                                 SdTh = D$sd1[a],
                                 Scenario = as.data.frame(out.scenario1[[i]])$Scenario_t[180:200],
                                 Th_pa = rep(parPredS1[[5]],21),
                                 H_min = rep(parPredS1[[7]], 21), 
                                 propMmax = as.data.frame(out.scenario1[[i]])$propMmax[180:200],
                                 Size = as.data.frame(out.scenario1[[i]])$N[180:200],
                                 Pred = as.data.frame(out.scenario1[[i]])$y[180:200],
                                 Pad = as.data.frame(out.scenario1[[i]])$a_vuln[180:200],
                                 A = as.data.frame(out.scenario1[[i]])$A[180:200],
                                 J = as.data.frame(out.scenario1[[i]])$J[180:200],
                                 Ratio = as.data.frame(out.scenario1[[i]])$J[180:200]/as.data.frame(out.scenario1[[i]])$A[180:200],
                                 Mortality = as.data.frame(out.scenario1[[i]])$m[180:200]),
                      
                     # S2
                     
                      data.frame (Simulation = rep (i,21),
                                  Pa = rep(parPrey[[1]],21), 
                                  SdPa = rep(parPrey[[2]],21), 
                                  Pj = rep(parPrey[[3]],21),
                                  SdPj = rep(parPrey[[4]],21),
                                  Pa_hs = rep(parPrey[[5]],21),
                                  Pa_delta = rep(parPrey[[6]],21),
                                  Pj_hs = rep(parPrey[[7]],21),
                                  Pj_delta = rep(parPrey[[8]],21),
                                  F_low = rep(parPrey[[9]],21), 
                                  F_growth = rep(parPrey[[10]],21), 
                                  Uc= rep(parPredS2[[1]], 21),
                                  Hc = rep(parPredS2[[2]], 21), 
                                  Lbdmax = rep(parPredS2[[3]], 21),
                                  Th_ext = rep(parPredS2[[4]], 21),
                                  Scal = rep(parPredS2[[6]],21), 
                                  Time = 180:200,
                                  Res = resmat[[a]][180:200,i],
                                  ResTh = D$res1[a],
                                  SdTh = D$sd1[a],
                                  Scenario = as.data.frame(out.scenario2[[i]])$Scenario_t[180:200], 
                                  Th_pa = rep(parPredS2[[5]],21),
                                  H_min = rep(parPredS2[[7]], 21),
                                  propMmax = as.data.frame(out.scenario2[[i]])$propMmax[180:200],
                                  Size = as.data.frame(out.scenario2[[i]])$N[180:200],
                                  Pred = as.data.frame(out.scenario2[[i]])$y[180:200],
                                  Pad = as.data.frame(out.scenario2[[i]])$a_vuln[180:200],
                                  A = as.data.frame(out.scenario2[[i]])$A[180:200],
                                  J = as.data.frame(out.scenario2[[i]])$J[180:200],
                                  Ratio = as.data.frame(out.scenario2[[i]])$J[180:200]/as.data.frame(out.scenario2[[i]])$A[180:200],
                                  Mortality = as.data.frame(out.scenario2[[i]])$m[180:200]),
                      
                      # S3 
                      data.frame (Simulation = rep (i,21),
                                  Pa = rep(parPrey[[1]],21), 
                                  SdPa = rep(parPrey[[2]],21), 
                                  Pj = rep(parPrey[[3]],21),
                                  SdPj = rep(parPrey[[4]],21),
                                  Pa_hs = rep(parPrey[[5]],21),
                                  Pa_delta = rep(parPrey[[6]],21),
                                  Pj_hs = rep(parPrey[[7]],21),
                                  Pj_delta = rep(parPrey[[8]],21),
                                  F_low = rep(parPrey[[9]],21), 
                                  F_growth = rep(parPrey[[10]],21), 
                                  Uc = rep(parPredS3[[1]], 21),
                                  Hc = as.data.frame(out.scenario3[[i]])$h[180:200],
                                  Lbdmax = rep(parPredS3[[3]], 21), 
                                  Th_ext = rep(parPredS3[[4]], 21),
                                  Scal = rep(parPredS3[[6]],21),
                                  Time= 180:200,
                                  Res = resmat[[a]][180:200,i],
                                  ResTh = D$res1[a],
                                  SdTh = D$sd1[a],
                                  Scenario = as.data.frame(out.scenario3[[i]])$Scenario_t[180:200], 
                                  Th_pa = rep(parPredS3[[5]],21),
                                  H_min = rep(parPredS3[[7]], 21),
                                  propMmax = as.data.frame(out.scenario3[[i]])$propMmax[180:200],
                                  Size = as.data.frame(out.scenario3[[i]])$N[180:200],
                                  Pred = as.data.frame(out.scenario3[[i]])$y[180:200],
                                  Pad = as.data.frame(out.scenario3[[i]])$a_vuln[180:200],
                                  A = as.data.frame(out.scenario3[[i]])$A[180:200],
                                  J = as.data.frame(out.scenario3[[i]])$J[180:200],
                                  Ratio = as.data.frame(out.scenario3[[i]])$J[180:200]/as.data.frame(out.scenario3[[i]])$A[180:200],
                                  Mortality = as.data.frame(out.scenario3[[i]])$m[180:200]),
                     
                     # S4 
                     data.frame (Simulation = rep (i,21),
                                 Pa = rep(parPrey[[1]],21), 
                                 SdPa = rep(parPrey[[2]],21), 
                                 Pj = rep(parPrey[[3]],21),
                                 SdPj = rep(parPrey[[4]],21),
                                 Pa_hs = rep(parPrey[[5]],21),
                                 Pa_delta = rep(parPrey[[6]],21),
                                 Pj_hs = rep(parPrey[[7]],21),
                                 Pj_delta = rep(parPrey[[8]],21),
                                 F_low = rep(parPrey[[9]],21), 
                                 F_growth = rep(parPrey[[10]],21), 
                                 Uc = rep(parPredS4[[1]], 21),
                                 Hc = as.data.frame(out.scenario4[[i]])$h[180:200],
                                 Lbdmax = rep(parPredS4[[3]], 21), 
                                 Th_ext = rep(parPredS4[[4]], 21),
                                 Scal = rep(parPredS4[[6]],21),
                                 Time = 180:200,
                                 Res = resmat[[a]][180:200,i],
                                 ResTh = D$res1[a],
                                 SdTh = D$sd1[a],
                                 Scenario = as.data.frame(out.scenario4[[i]])$Scenario_t[180:200], 
                                 Th_pa = rep(parPredS4[[5]],21),
                                 H_min = rep(parPredS4[[7]], 21),
                                 propMmax = as.data.frame(out.scenario4[[i]])$propMmax[180:200],
                                 Size = as.data.frame(out.scenario4[[i]])$N[180:200],
                                 Pred = as.data.frame(out.scenario4[[i]])$y[180:200],
                                 Pad = as.data.frame(out.scenario4[[i]])$a_vuln[180:200],
                                 A = as.data.frame(out.scenario4[[i]])$A[180:200],
                                 J = as.data.frame(out.scenario4[[i]])$J[180:200],
                                 Ratio = as.data.frame(out.scenario4[[i]])$J[180:200]/as.data.frame(out.scenario4[[i]])$A[180:200],
                                 Mortality = as.data.frame(out.scenario4[[i]])$m[180:200]))
    }
  
   
   
   
#========================================================================================================================================================
   
### Calculation of mean prey population size, mean predator population size and mean proportion of adult prey (over the last 21 years of the simulation) - summary data ####
    
    
    results2 <- ddply(results, ~ResTh + SdTh + Simulation + Scenario + Pa + SdPa + Pj + SdPj + Pa_delta + Pa_hs + Pj_delta + Pj_hs + F_low + F_growth + Th_pa + H_min + Uc + Lbdmax + Th_ext + Scal, function(x) {
      return(data.frame(
        Mean = mean(x$Size), # Mean prey population size
        Meanpred = mean(x$Pred), # Mean predator population size 
        Meanpad = mean(x$Pad) # Mean proportion of vulnerable adult prey 
      ))})
    
  ### File containing raw data (the raw outcomes from the model) ####
    
    if(dorawdata == TRUE) { 
    
    if (a == 1){
      write.table(results, paste(dir2, "Raw_Sim_LongTerm_Defaultpar_HuntingSuccess", HuntingSuccess, "_z", z, "_t", t, ".txt", sep = ""), row.names = FALSE)
    } else {
      write.table(results, paste(dir2, "Raw_Sim_LongTerm_Defaultpar_HuntingSuccess", HuntingSuccess, "_z", z, "_t", t, ".txt", sep = ""), append = TRUE, row.names = FALSE, col.names = FALSE)}
    } # End dorawdata

    
### File containing mean population size data per simulation - summary data ####
    
      if (a == 1){ 
        write.table(results2, paste(dir2, "Sim_LongTerm_Defaultpar_HuntingSuccess", HuntingSuccess, "_z", z, "_t", t, ".csv", sep= ""), row.names = FALSE, sep = ";")
      } else {
        write.table(results2, paste(dir2, "Sim_LongTerm_Defaultpar_HuntingSuccess", HuntingSuccess,"_z", z, "_t", t, ".csv", sep = ""), append = TRUE, row.names = F, sep = ";", col.names = FALSE) }
    
    
    
    
    ### Re-initialisation ==============================================================================================================================
    
    results<-data.frame (Simulation = numeric(),
                         Pa = numeric(), 
                         SdPa = numeric(), 
                         Pj = numeric(),
                         SdPj = numeric(),
                         Pa_hs = numeric(),
                         Pa_delta = numeric(),
                         Pj_hs = numeric(),
                         Pj_delta = numeric(),
                         F_low = numeric(), 
                         F_growth = numeric(), 
                         Uc = numeric(),
                         Hc = numeric (), 
                         Lbdmax = numeric(),
                         Th_ext = numeric(),
                         Scal = numeric(),
                         Time = numeric(),
                         Res = numeric(),
                         ResTh = numeric(),
                         SdTh = numeric(),
                         Scenario = numeric(),
                         Th_pa = numeric(),
                         H_min = numeric(), 
                         propMmax = numeric(),
                         Size = numeric(),
                         Pred = numeric(),
                         Pad = numeric(),
                         A = numeric(),
                         J = numeric(),
                         Ratio = numeric(),
                         Mortality = numeric())
  
    
 }
  

} # End function Sim_LongTerm