


##### THE PREDATOR PREY MODEL #####



#### DESCRIPTION #####################################################################################################################################


# This script displays the code for the predator-prey model 
 

######################################################################################################################################################




model <- function(resDyn, prey0, pred0, parPrey, parPred, predDyn = TRUE, list_h, Scenario, HuntingSuccess) {  
  
  
  
  
  #### Default parameters to see how the model works ##### ===========================================================================================
  

  # # Table containing Mean/Standard deviation pairs used to calculate rainfall for a given year
  
  # D <- as.data.frame(cbind(c(seq(300, 900, by = 100)), c(rep(90,7)))) 
  # names(D) <- c("res1", "sd1")

  # # Rainfall 
  
  # resmat <- vector("list", nrow(D)) # to store rainfall values for each time step
  # 
  # for (j in 1:nrow(D)) { # Start rainfall , with the table "D" containing mean/standard deviation pairs used to calculate rainfall in the system
  #   
  #   
  #   resall <- rnorm(t*z, mean = (D$res1[j]), sd = (D$sd1[j])) # z*t values of rainfall are generated, with z the number of simulations ( default =1000),  t: the number of time steps within a simulation (default =201) 
  #   
  #   resmat[[j]] <- matrix(resall, t, z) # Matrix containing the values of rainfall previously generated, with the number of lines being equal to the number of years in a simulation (t), and as many columns as simulations (z)
  #   
  #   # To avoid values equal or below zero #   
  #   
  #   if(any(resmat[[j]] <= 0)){
  #     
  #     resmat[[j]][resmat[[j]] <=  0] <- sample(1:20, replace = TRUE, length(resmat[[j]][resmat[[j]] <= 0]))
  #     
  #   }
  # } # End rainfall
  
  # k <- 1 # to test with one value of rainfall 
  # resDyn <- resmat[,k]

  ### Prey parameters (default values) ####
  
  # parPrey <- list(
  #   Pa = 0.95, # Maximum adult prey survival probability
  #   sdPa = 0.05, # Standard deviation, variation of adult prey survival
  #   Pj = 0.8, # Maximum juvenile prey survival probability
  #   sdPj = 0.05, # Standard deviation, variation of juvenile prey survival
  #   pa_hs = 30, # Adult half-saturation, point at which adult prey survival is lowered by half
  #   pa_delta = 2, # Shape parameter, defines the onset of density-dependence for adult prey
  #   pj_hs = 20, # Juvenile half saturation, point at which juvenile prey survival is lowered by half
  #   pj_delta = 2, # Shape parameter, defines the onset of density-dependence for juvenile prey
  #   f_low = 100, # Value determining fecundity value when adult survival is close from 0
  #   f_growth = 15) # Rate at which fecundity value reaches 1 
# 
# 
  # #### Predation parameters (default values) ####
  # 
  # # Scenario 1 
  # 
  # parPredS1 <- list(  
  #   uc = 0.0002, # Encounter rate
  #   hc = 5, # Handling time 
  #   lambdamax = 1.8, # Predator maximum growth rate
  #   th_ext = 0, #  Threshold below which predator population become extinct 
  #   th_pa = 1, # Prey threshold of survival probability below which predators can catch and consume the prey
  #   scal = 0.3,# Interference between predators in the predator functional response
  #   h_min = 5) #Lowest value that can be taken by the handling time across all scenarios
  # 
  # 
  # # Scenario 2
  # 
  # parPredS2 <- list(  
  #   uc = 0.0002, 
  #   hc = 5, 
  #   lambdamax = 1.8, 
  #   th_ext = 0, 
  #   th_pa = 0.5, 
  #   scal = 0.3, 
  #   h_min = 5)
  # 
  # # Scenario 3
  # 
  # parPredS3 <- list(  
  #   uc = 0.0002,  
  #   hc = NULL, # Here the  Handling time is set to be NULL because it will vary in each time steps and will be generated by the model
  #   lambdamax = 1.8, 
  #   th_ext = 0,    
  #   th_pa = 1, 
  #   scal = 0.3,
  #   h_min = 5)
  # 
  # # Scenario 4
  # 
  # parPredS4 <- list(  
  #   uc = 0.0002, 
  #   hc = NULL, #  # Here the  Handling time is set to be NULL because it will vary in each time steps and will be generated by the model 
  #   lambdamax = 1.8, 
  #   th_ext = 0, 
  #   th_pa = 0.5,
  #   scal = 0.3,
  #   h_min = 5)
# 
  # # Parameters to calculate the handling time when the hanlding time (and hunting success) varies with rainfall
  
  # list_h <- list(A = 5, #Lowest value that can be taken by the handling time across all scenarios
  #              K = 8, # Highest value that can be taken by the handling time across all scenarios
  #              B = 0.015, # Maximum rate of change of the handling time
  #              M = 600) # Rainfall value for which the rate of change of the handling time is maximum (or inflexion point)
  

# prey0 <- c(5000,15000) # Initial number of prey
  
# pred0 <- 10 # initial number of predators
# predDyn = TRUE
# parPred <- parPredS4
# Scenario = 4
# HuntingSuccess = "positive"

  
#### End default parameters to see how the model works===============================================================================================
  
  
  

### MODEL ##### 
  
  
  ### Initialisation ==============================================================================================================================
  
  t = length(resDyn) # Number of time steps in the simulation (equal to the number of rainfall values = 200 years)
  
  ### Scaling function allowing to account for density- and resource-dependence in survival ####
  
  dd <- function(pop, res, halfsat, delta) {
    g <- (halfsat^delta)/(halfsat^delta + (pop/res)^delta)  
    return(g)
  }

  #### Capturing and handling time - Scenario 3 & 4 ####
  
  if(Scenario == 3 | Scenario == 4) { # Start "if Scenario 3|4"
    
    if(HuntingSuccess == "positive") { # If habitat driven hunting success varies positively with rainfall (i.e. Handling time varies negatively with rainfall)
      
  Sig_h <- function(A, K, B, M, x) {
    A + ((K-A)/(1 + exp(B*(x-M)))) 
    }
  
  h <- rep(NA, t) # h vector to store h outcomes
  
  } else if (HuntingSuccess == "negative") { # If habitat driven hunting success varies negatively with rainfall(i.e. Handling time varies positively with rainfall)
    
      Sig_h <- function(A, K, B, M, x) { 
        A + ((K-A)/(1 + exp(-B*(x-M)))) 
        }
      h <- rep(NA, t) 
    }
  } # End if Scenario 3|4
  
  propMmax <- rep(NA,t)

  # Creation of the matrices that will store model outcomes #####
  
  nmat <- matrix(NA,t,2)  # Prey matrix 
  nmat[1,] <- prey0 # Initial number of prey 
  colnames(nmat) <- c('J','A')
  
  N <- rep(NA, t) # Vector of total number of prey (?)
  N[1] <- rowSums(nmat)[1]
  

  g <- matrix(NA,t,2) # Scaling function g matrix
  colnames(g) <- c("gjuv","gad")
  
  v <- matrix(NA,t,2)# Matrix containing adult prey mean survival rate (pa) and the proportion of vulnerable adult prey in the prey population (a_vuln)
  colnames(v) <- c("pa", "a_vuln")

 
    
  y <- rep(NA, t)# Vector of predator populations
  y[1] <- pred0 # Initilal number of predators in the system
  
  m <- rep(NA, t) # Matrix containing mortality values 

  
  Scenario_t<-rep(Scenario, t)
  
  
  
  ### Model ======================================================================================================================================
  
  for (i in 2:t){ 
      
      # Prey model 
    
      # Juvenile prey survival
    
      g[i-1,1] <- dd(pop = N[i-1], res = resDyn[i-1], halfsat = parPrey$pj_hs, delta = parPrey$pj_delta) # Scaling function g for juvenile prey
      pj <- parPrey$Pj*g[i-1,1]# Pj*gj = pj
      dpj <- rnorm(nmat[i-1,1], mean = pj, sd = parPrey$sdPj) # Individual survival probabilities drawn from a normal distribution (one value for each juvenile prey)
      dpj[dpj>1] <- 1; dpj[dpj<0] <- 0 # Control
      
      # Adult prey survival
      
      g[i-1,2] <- dd(pop = N[i-1], res = resDyn[i-1], halfsat = parPrey$pa_hs, delta = parPrey$pa_delta) # Scaling function g for adult prey
      pa <- parPrey$Pa*g[i-1] # Pa*ga = pa
      v[i-1,1] <- pa # We store "pa" values
      dpa <- rnorm(nmat[i-1,2], mean = pa, sd = parPrey$sdPa) # Individual survival probabilities drawn from a normal distribution (one value for each adult prey)
      dpa[dpa>1] <- 1; dpa[dpa<0] <- 0 # Control
      
      
     
      # Integrating predation into the prey model -----------------------------------------------------------------------------------------------------
    
      
      
      ad_vuln <- which(dpa <= parPred$th_pa) # Any adult prey with an individual survival probability (pa) below the threshold of survival probability (Th_pa)
      n_ad_vuln <- length(ad_vuln) # Number of vulnerable adult prey
      v[i-1,2] <- n_ad_vuln/length(dpa) # Proportion of vulnerable adult prey 
      
      # Available prey 
      ntemp0 <- nmat[i-1,1] + n_ad_vuln # ntemp0: intial number of available prey (all juveniles and vulnerable adult prey (a_vuln))
      ntemp <- ntemp0
      
      
      #Predation 
      
      if(y[i-1] > 0 & ntemp > 0){ 
        
        if(Scenario == 3 | Scenario== 4){ # Start scenario loop: Scenario 3 and 4 are the two scenarios for which h varies with rainfall 
          
          h[i-1] <- Sig_h(list_h$A, list_h$K, list_h$B, list_h$M, resDyn[i-1]) 
    
          for(ii in 1:365){ # Number of prey consumed over 365 days (i.e. a year)
          
            c <- y[i-1]*(parPred$uc*ntemp)/(1 + parPred$scal*y[i-1] + parPred$uc*h[i-1]*ntemp) # Functional response, here the handling time (h) varies with rainfall
            ntemp <- ifelse((ntemp-c) > 0, ntemp-c, 0)} # Removal of consumed prey after each iteration 
            
          } else { # Scenario == 0,1 ou 2
          
          for(ii in 1:365){ # Number of prey consumed over 365 days (i.e. a year)
            
          c <- y[i-1]*(parPred$uc*ntemp)/(1 + parPred$scal*y[i-1] + parPred$uc*parPred$hc*ntemp) # Functional response, here the handling time (hc) is constant and does not vary with rainfall 
          ntemp <- ifelse((ntemp-c) > 0, ntemp-c, 0)} # Removal of consumed prey after each iteration 
        
            } # End scenario loop
        
        # Prey mortality
        
        m[i-1] <- ntemp0 - ntemp # Number of prey before predation minus the number of prey that remains after predation, giving the number of prey consumed over a year 
        m_j <- m[i-1]*(nmat[i-1,1]/ ntemp0) # Number of juvenile prey consummed 
        m_a <- m[i-1]-m_j # Number of (vulnerable) adult prey consummed
        
        
        
        
       # Predator and prey populations update --------------------------------------------------------------------------------------------------------
        
        
        
        # Predator population update
        
       if(isTRUE(predDyn)){
         
        if(y[i-1] > 0){
            
       propMmax[i-1] <- (m[i-1]/y[i-1])/(365*(1/parPred$h_min)) # Predator hunting efficiency over a year 
       
       propMmax[i-1] <- ifelse(propMmax[i-1] < parPred$th_ext, 0, propMmax[i-1]) # Comparison of P_rel values to the threshold at which the predator population becomes extinct (parPred$th_ext), equal to 0 
         y[i] <- parPred$lambdamax*propMmax[i-1]*y[i-1] # Predator numerical response 
        } else {y[i] <- 0}
       } else {y[i] <- pred0}
        
        
        
      # Prey population update
        
      dpj_temp <- sample(dpj, nmat[i-1,1]-m_j) # Number of juvenile prey at the begining of the year minus the number of juvenile prey consummed, allowing to only keep the juvenile prey not consummed
      if(m_a > 1){dpa_temp <- dpa[-sample(ad_vuln,m_a)]} else {dpa_temp <- dpa} #  dpa_temp: we only keep the adult prey which have survived by removing the adult prey which have been consummed from the pool of vulnerable adult prey 
      
      } else {m[i-1] <- 0; y[i] <- 0; dpj_temp <- dpj; dpa_temp <- dpa} 
      
      # Stochasticity
      # Each prey individual survival probability is compared to a random value drawn from a uniform distribution between 0 and 1, if the           individual survival probability is higher than the random value, the prey survives. 
      s_j <- length(which(runif(length(dpj_temp)) < dpj_temp))
      s_a <- length(which(runif(length(dpa_temp)) < dpa_temp)) 
      
      f_a_pred <- 1/(1 + parPrey$f_low*exp(-parPrey$f_growth*dpa_temp)) # Fecundity values 
      f_a <- length(which(runif(length(dpa_temp)) < f_a_pred)) # Each (adult) prey fecundity value is compared to a random value drawn from a uniform distribution between 0 and 1, if the fecundity value is higher than the random value, the prey reproduces and produces one offspring
      
      
      nmat[i,2] = s_j + s_a # Number of adult prey at the begining of the year t+1 (adults and juveniles that have survived year t)
      nmat[i,1] = f_a # Number of offspring produce during the year t
      
      N[i] <- rowSums(nmat)[i] 
     
  }
  
  
  
  # Model outcomes  ==============================================================================================================================
  
  if(Scenario == 3 | Scenario == 4){
   out <- cbind(nmat, N, v, y, m, resDyn, g, Scenario_t, h, propMmax)
  }else{
  out <- cbind(nmat, N, v, y, m, resDyn, g, Scenario_t, propMmax)  
   }
   return(out)
  }

