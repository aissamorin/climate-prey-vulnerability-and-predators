

##### Function for the simulation of the immediate response of predator populations to specific rainfall conditions ####




#### DESCRIPTION ########################################################################################################################################


# This script displays the code for the simulation for the long-term response of predator populations to changes in mean annual rainfall. 


#########################################################################################################################################################





### Function ####




Sim_ShortTerm <- function(t= 200, z = 1000, HuntingSuccess = NULL, dir1 = ".", dir2 = ".", dorawdata = FALSE) { # Start function 
  
  

  ### Defaut parameters to see how the simulation function works ====================================================================================== 
  
  
  
  
  # t = 200 # Number of time steps, set to 201 because of the model construction: some variables are calculated at the time step t+1, if it is not take into account, those variables won't have values at the time t = 200.
  # z = 2 # Number of simulations (default = 1000)
  # HuntingSuccess = "positive" # Functional relationship between rainfall and predator habitat-driven hunting success
  # dir1 = ""."  # Directory where the source files can be found 
  # dir2 = "./"   # Directory where the simulation output files should be saved
  # dorawdata = FALSE # TRUE if you want the raw data, FALSE otherwise
  
  
  #===================================================================================================================================================
  
  
  
# Package 

library(plyr) # Version 1.8.4
  

###  Call model ####

setwd(dir1)
source("R/01_predator-prey_model_2019.R") # The predator-prey model 



#### Function for calculating the predator population growth rate over two time steps ####

  
div <- function(Y) {
  
  for (i in 2:2){
    lmbd<- Y[i]/Y[i-1]
    }
  return(lmbd) }


### Prey and predation parameters ====================================================================================================================



# Prey parameters (default values)

parPrey <- list(
  Pa = 0.95, # Maximum adult prey survival probability
  sdPa = 0.05, # Standard deviation, variation of adult prey survival
  Pj = 0.8,# Maximum juvenile prey survival probability
  sdPj = 0.05, # Standard deviation, variation of juvenile prey survival
  pa_hs = 30, # Adult half-saturation, point at which adult prey survival is lowered by half
  pa_delta = 2, # Shape parameter, defines the onset of density-dependence for adult prey
  pj_hs = 20, # Juvenile half saturation, point at which juvenile prey survival is lowered by half
  pj_delta = 2, # Shape parameter, defines the onset of density-dependence for juvenile prey
  f_low = 100, # Value determining fecundity value when adult survival is close from 0
  f_growth = 15) # Rate at which fecundity value reaches 1   




# Predation parameters (default values) 

parPredS1 <- list(  
  uc = 0.0002, # Encounter rate
  hc = 5,  # Handling time  
  lambdamax = 1.8, # Predator maximum growth rate
  th_ext = 0, # Threshold below which predator population become extinct
  th_pa = 1, # Prey threshold of survival probability below which predators can catch and consume the prey
  scal = 0.3, # Interference between predators in the predator functional response
  h_min = 5) # Lowest value that can be taken by the handling time across all scenarios

parPredS2 <- list(  
  uc = 0.0002, 
  hc = 5,  
  lambdamax = 1.8, 
  th_ext = 0, 
  th_pa = 0.5,
  scal = 0.3, 
  h_min = 5)

parPredS3 <- list(  
  uc = 0.0002, 
  hc = NULL, # Here the  Handling time is set to be NULL because it will vary in each time steps and will be generated by the model 
  lambdamax = 1.8, 
  th_ext = 0,
  th_pa = 1,
  scal = 0.3, 
  h_min=5)
  
parPredS4 <- list(  
  uc = 0.0002, 
  hc = NULL,  # Here the  Handling time is set to be NULL because it will vary in each time steps and will be generated by the model
  lambdamax = 1.8, 
  th_ext = 0, 
  th_pa = 0.5,
  scal = 0.3, 
  h_min = 5)



### Parameters to calculate the handling time when the hanlding time (and hunting success) varies with rainfall ####

list_h <- list(A = 5, # Lowest value that can be taken by the handling time across all scenarios
             K = 8, # Highest value that can be taken by the handling time across all scenarios
             B = 0.015, # Maximum rate of change of the handling time
             M = 600) # Rainfall value for which the rate of change of the handling time is maximum (or inflexion point)




####  Initialisation =====================================================================================================================================

### Table for storing the outcomes of the simulation  #### 

results <- data.frame (Simulation = numeric(), # Number of simulations
                     Pa = numeric(), # Maximum adult prey survival probability
                     SdPa = numeric(), # Standard deviation, variation of adult prey survival
                     Pj = numeric(), # Maximum juvenile prey survival probability 
                     SdPj = numeric(), # Standard deviation, variation of juvenile prey survival
                     Pa_hs = numeric(), # Adult half-saturation, point at which adult prey survival is lowered by half
                     Pa_delta = numeric(), # Shape parameter, defines the onset of density-dependence for adult prey
                     Pj_hs = numeric(), # Juvenile half saturation, point at which juvenile prey survival is lowered by half
                     Pj_delta = numeric(), # Shape parameter, defines the onset of density-dependence for juvenile prey
                     F_low = numeric(), # Value determining fecundity value when adult survival is close from 0
                     F_growth = numeric(), # Rate at which fecundity value reaches 1
                     Uc = numeric(), # Encounter rate in the predator functional response
                     Hc = numeric (), # Predator handling time for one prey in the predator functional response
                     Lbdmax = numeric(), # Predator maximum growth rate
                     Th_ext = numeric(), # Threshold below which predator population become extinct 
                     Scal = numeric(), # Interference between predators in the predator functional response 
                     Time = numeric(), # Time step (within the simulation)
                     Res = numeric(), # Rainfall value calculated for the year
                     ResTh = numeric(), # Mean value of rainfall for the ith simulation 
                     Resfor = numeric(),# Specific value of rainfall   
                     SdTh = numeric(), # Standard deviation value of rainfall for the ith simulations 
                     Scenario = numeric(), # Scenario
                     Th_pa = numeric(), # Prey threshold of survival probability below which predators can catch and consume the prey
                     H_min= numeric(), # Lowest value that can be taken by the handling time across all scenarios
                     Size = numeric(), # Model outcome : Prey population size at each time step
                     Pred = numeric(), # Model outcome : Predator population size at each time step
                     Lbdfin = numeric(), # Predator growth rate calculated over the last two time steps 
                     Pad = numeric(), # Model outcome : Proportion of vulnerable adult prey at each time step
                     Pafin = numeric()) # Proportion of vulnerable adult prey calculated over the last two  time steps



# Generating rainfall data ####

# Table containing the mean value of rainfall in the system (sys)/specificic value of rainfall (resfor) pairs to be tested in the simulations
# Resfor = Specific value of  rainfall imposed during the 199th year and which can take values from 300mm to 900mm, by 100mm increments

T = expand.grid(sys = 600, resfor = seq(300, 900, by = 100)) 

# To store rainfall values for each time step

resmat <- vector("list", nrow(T))
resmato = matrix(NA, t, z)


for (j in 1:nrow(T)) { # Start rainfall :
  
  for(k in 1:z) { # Columns = simulations, z= number of simulations 
    
    resmato[,k]<-c(rnorm(t-2, mean = (T$sys[j]), sd = 90), T$resfor[j], rnorm(1, mean = (T$sys[j]), sd = 90))
    }
  
  
  # 1) 198 rainfall values are generated, drawn from a normal distribution with mean = 600 (mean rainfall in the system): they correspond to rainfall values for the 198th first years of the zth simulation (see below)
  # 2) For the 199th year, a specific value (corresponding to resfor) is imposed 
  # 3) The last rainfall value (at t = 200) is drawn from a normal distribution with mean = 600
  
  # To avoid values equal or below zero  
  
    if(any(resmato <= 0)){
      
      resmato[,k][resmato[,k] <= 0] <- sample(1:20, replace = TRUE, length(resmato[,k][ resmato[,k] <= 0])) 
     
       }
  
    resmat[[j]] <- resmato
    } # End rainfall



# To store model outcomes 

out.scenario1 <- vector("list", z) # Scenario 1: Climatic conditions influence predator-prey interactions only through their influence on prey survival and fecundity, i.e. through prey abundance only  
out.scenario2 <- vector("list", z) # Scenario 2: Prey vulnerability is affected by climatic conditions through their influence on prey body condition 
out.scenario3 <- vector("list", z) # Scenario 3: Prey vulnerability is affected by climatic conditions through climate-driven changes in habitat characteristics 
out.scenario4 <- vector("list", z) # Scenario 4: Prey vulnerability is affected by both prey body condition and climate-driven changes in habitat characteristics


##### SIMULATIONS ===================================================================================================================================

  
  for (a in 1:nrow(T)) { # "nrow(T)" is the number of mean/specific value pairs to be tested

    print(paste("a:",a))
    
    for(i in 1:z) { # z simulations will be run for each ean/specific value pairs 
      
      
      print(paste("i:",i))
      
      ### MODEL RUN ####
      
      ##### Scenario 1 #####

      
      out.scenario1[[i]] <- model(resDyn = resmat[[a]][,i], # Rainfall values corresponding to the ath mean/specific value pair and the ith simulation
                             prey0 = c(5000,15000), # Initial number of prey (juveniles and adults)
                             pred0 = 10, # Initial number of predators 
                             parPrey = parPrey, # List containing prey parameters
                             parPred = parPredS1, # List containing predation parameters
                             predDyn = TRUE,
                             list_h = NULL, # The handling time does not vary with rainfall 
                             Scenario = 1,
                             HuntingSuccess = HuntingSuccess) # Whether the hunting success varies positively or negatively with rainfall 
      
      
      #### Scenario 2 #####
      
      
      out.scenario2[[i]] <- model(resDyn = resmat[[a]][,i],
                              prey0 = c(5000,15000),
                              pred0 = 10,
                              parPrey = parPrey,
                              parPred = parPredS2,
                              predDyn = TRUE, 
                              list_h = NULL,
                              Scenario = 2,
                              HuntingSuccess = HuntingSuccess)
      
      
      
      #### Scenario 3 ####
      
      
      out.scenario3[[i]] <- model(resDyn = resmat[[a]][,i],
                                 prey0 = c(5000,15000),
                                 pred0 = 10,
                                 parPrey = parPrey,
                                 parPred = parPredS3,
                                 predDyn = TRUE,
                                 list_h = list_h, # List containing parameters for calulcating the handling time because in this scenario the handling time varies with rainfall 
                                 Scenario = 3,
                                 HuntingSuccess = HuntingSuccess)
      
      
      #### Scenario 4 ##### 
      
      out.scenario4[[i]] <- model(resDyn = resmat[[a]][,i],
                                 prey0 = c(5000,15000),
                                 pred0 = 10,
                                 parPrey = parPrey,
                                 parPred = parPredS4,
                                 predDyn = TRUE, 
                                 list_h = list_h, # List containing parameters for calulcating the handling time because in this scenario the handling time varies with rainfall 
                                 Scenario = 4,
                                 HuntingSuccess = HuntingSuccess)
      
      
      
      
      #### Organizing results ####
      # NB: we only stored the years 180th to 200th for each simulation
      
      results<-rbind(results,
                     
                     # S1
                     data.frame (Simulation = rep (i,21),
                                 Pa = rep(parPrey[[1]],21), 
                                 SdPa = rep(parPrey[[2]],21), 
                                 Pj = rep(parPrey[[3]],21),
                                 SdPj = rep(parPrey[[4]],21),
                                 Pa_hs = rep(parPrey[[5]],21),
                                 Pa_delta = rep(parPrey[[6]],21),
                                 Pj_hs = rep(parPrey[[7]],21),
                                 Pj_delta = rep(parPrey[[8]],21),
                                 F_low = rep(parPrey[[9]],21), 
                                 F_growth = rep(parPrey[[10]],21), 
                                 Uc = rep(parPredS1[[1]], 21),
                                 Hc = rep(parPredS1[[2]], 21), 
                                 Lbdmax = rep(parPredS1[[3]], 21), 
                                 Th_ext = rep(parPredS1[[4]], 21),
                                 Scal = rep(parPredS1[[6]],21),
                                 Time = 180:200,
                                 Res = resmat[[a]][180:200,i],
                                 ResTh = T$sys[a],
                                 Resfor= T$resfor[a],
                                 SdTh = rep(90,21),
                                 Scenario = as.data.frame(out.scenario1[[i]])$Scenario_t[180:200],
                                 Th_pa = rep(parPredS1[[5]],21),
                                 H_min= rep(parPredS1[[7]], 21),
                                 Size = as.data.frame(out.scenario1[[i]])$N[180:200],
                                 Pred = as.data.frame(out.scenario1[[i]])$y[180:200],
                                 Lbdfin = div(as.data.frame(out.scenario1[[i]])$y[199:200]), # The "div" function is applied over the 199th and the 200th years
                                 Pad = as.data.frame(out.scenario1[[i]])$a_vuln[180:200],
                                 Pafin = as.data.frame(out.scenario1[[i]])$a_vuln[199]),
                     
                     # S2
                     data.frame (Simulation = rep (i,21),
                                 Pa = rep(parPrey[[1]],21), 
                                 SdPa = rep(parPrey[[2]],21), 
                                 Pj = rep(parPrey[[3]],21),
                                 SdPj = rep(parPrey[[4]],21),
                                 Pa_hs = rep(parPrey[[5]],21),
                                 Pa_delta = rep(parPrey[[6]],21),
                                 Pj_hs = rep(parPrey[[7]],21),
                                 Pj_delta = rep(parPrey[[8]],21),
                                 F_low = rep(parPrey[[9]],21), 
                                 F_growth = rep(parPrey[[10]],21), 
                                 Uc = rep(parPredS2[[1]], 21),
                                 Hc = rep(parPredS2[[2]], 21), 
                                 Lbdmax = rep(parPredS2[[3]], 21),
                                 Th_ext = rep(parPredS2[[4]], 21),
                                 Scal = rep(parPredS2[[6]],21),
                                 Time = 180:200,
                                 Res = resmat[[a]][180:200,i],
                                 ResTh = T$sys[a],
                                 Resfor = T$resfor[a],
                                 SdTh = rep(90,21),
                                 Scenario = as.data.frame(out.scenario2[[i]])$Scenario_t[180:200],
                                 Th_pa = rep(parPredS2[[5]],21),
                                 H_min= rep(parPredS2[[7]], 21),
                                 Size = as.data.frame(out.scenario2[[i]])$N[180:200],
                                 Pred = as.data.frame(out.scenario2[[i]])$y[180:200],
                                 Lbdfin = div(as.data.frame(out.scenario2[[i]])$y[199:200]), # The "div" function is applied over the 199th and the 200th years
                                 Pad = as.data.frame(out.scenario2[[i]])$a_vuln[180:200], 
                                 Pafin = as.data.frame(out.scenario2[[i]])$a_vuln[199]),
                     
                     # S3
                     data.frame (Simulation = rep (i,21),
                                 Pa = rep(parPrey[[1]],21), 
                                 SdPa = rep(parPrey[[2]],21), 
                                 Pj = rep(parPrey[[3]],21),
                                 SdPj = rep(parPrey[[4]],21),
                                 Pa_hs = rep(parPrey[[5]],21),
                                 Pa_delta = rep(parPrey[[6]],21),
                                 Pj_hs = rep(parPrey[[7]],21),
                                 Pj_delta = rep(parPrey[[8]],21),
                                 F_low = rep(parPrey[[9]],21), 
                                 F_growth = rep(parPrey[[10]],21), 
                                 Uc = rep(parPredS3[[1]], 21),
                                 Hc = as.data.frame(out.scenario3[[i]])$h[180:200], 
                                 Lbdmax = rep(parPredS3[[3]], 21),
                                 Th_ext = rep(parPredS3[[4]], 21),
                                 Scal = rep(parPredS3[[6]],21),
                                 Time = 180:200,
                                 Res = resmat[[a]][180:200,i],
                                 ResTh = T$sys[a],
                                 Resfor = T$resfor[a],
                                 SdTh = rep(90,21),
                                 Scenario = as.data.frame(out.scenario3[[i]])$Scenario_t[180:200],
                                 Th_pa = rep(parPredS3[[5]],21),
                                 H_min= rep(parPredS3[[7]], 21),
                                 Size = as.data.frame(out.scenario3[[i]])$N[180:200],
                                 Pred = as.data.frame(out.scenario3[[i]])$y[180:200],
                                 Lbdfin = div(as.data.frame(out.scenario3[[i]])$y[199:200]), # The "div" function is applied over the 199th and the 200th years
                                 Pad = as.data.frame(out.scenario3[[i]])$a_vuln[180:200], 
                                 Pafin = as.data.frame(out.scenario3[[i]])$a_vuln[199]),
                     # S4
                     data.frame (Simulation = rep (i,21),
                                 Pa = rep(parPrey[[1]],21), 
                                 SdPa = rep(parPrey[[2]],21), 
                                 Pj = rep(parPrey[[3]],21),
                                 SdPj = rep(parPrey[[4]],21),
                                 Pa_hs = rep(parPrey[[5]],21),
                                 Pa_delta = rep(parPrey[[6]],21),
                                 Pj_hs = rep(parPrey[[7]],21),
                                 Pj_delta = rep(parPrey[[8]],21),
                                 F_low = rep(parPrey[[9]],21), 
                                 F_growth = rep(parPrey[[10]],21), 
                                 Uc = rep(parPredS4[[1]], 21),
                                 Hc = as.data.frame(out.scenario4[[i]])$h[180:200], 
                                 Lbdmax = rep(parPredS4[[3]], 21),
                                 Th_ext = rep(parPredS4[[4]], 21),
                                 Scal = rep(parPredS4[[6]],21),
                                 Time = 180:200,
                                 Res = resmat[[a]][180:200,i],
                                 ResTh = T$sys[a],
                                 Resfor = T$resfor[a],
                                 SdTh = rep(90,21),
                                 Scenario = as.data.frame(out.scenario4[[i]])$Scenario_t[180:200],
                                 Th_pa = rep(parPredS4[[5]],21),
                                 H_min= rep(parPredS4[[7]], 21),
                                 Size = as.data.frame(out.scenario4[[i]])$N[180:200],
                                 Pred = as.data.frame(out.scenario4[[i]])$y[180:200],
                                 Lbdfin = div(as.data.frame(out.scenario4[[i]])$y[199:200]), # The "div" function is applied over the 199th and the 200th years
                                 Pad = as.data.frame(out.scenario4[[i]])$a_vuln[180:200], 
                                 Pafin = as.data.frame(out.scenario4[[i]])$a_vuln[199]))
    }

    
    
    
    #=====================================================================================================================================================
    
    
    
    ### Calculation of mean prey and predator population size (over the last 20 years of the simulation) -  summary data #####
  
    
    results2 <- ddply(results, ~Scenario + ResTh + Resfor + Simulation + SdTh + Pa + SdPa + Pj + SdPj + Pa_delta + Pa_hs + Pj_delta + Pj_hs + F_low + F_growth + Uc + Lbdmax + Th_ext + Scal + Th_pa + H_min, function(x) {
      return(data.frame(
        Lbdfin = unique(x$Lbdfin), # Predator growth rate calculated over the last two years for each simulations
        Pafin = unique(x$Pafin)))}) # Proportion of adult prey calculated over the last two years for each simulations
    
    ### File containing raw data (the raw outcomes from the model) ####
    
    if(dorawdata == TRUE) { 
    
    if (a == 1){
      
      write.table(results, paste(dir2, "Raw_Sim_ShortTerm_Defaultpar_HuntingSuccess", HuntingSuccess, "_z", z, "_t", t, ".txt", sep = ""), row.names = FALSE)
    } else {
     
      write.table(results, paste(dir2, "Raw_Sim_ShortTerm_Defaultpar_HuntingSuccess", HuntingSuccess, "_z", z, "_t", t, ".txt", sep = ""), append = TRUE, row.names = FALSE, col.names = FALSE)
      
      }
    } # End dorawdata
    

    ### File containing predator population rowth rates and proportion of vulnerable adult prey per simulation - summary data ####
    
    if (a == 1){# 
      
      write.table(results2, paste(dir2, "Sim_ShortTerm_Defaultpar_HuntingSuccess", HuntingSuccess, "_z", z, "_t", t, ".csv", sep = ""), row.names = FALSE, sep=";")
      
    } else {
       
      write.table(results2, paste(dir2, "Sim_ShortTerm_Defaultpar_HuntingSuccess", HuntingSuccess, "_z", z, "_t", t, ".csv", sep = ""), append = TRUE, row.names = FALSE, sep = ";", col.names = FALSE)
      
      }
    
    
    # Re-initialisation ===================================================================================================================================
    
    results <- data.frame (Simulation = numeric(),
                         Pa = numeric(), 
                         SdPa = numeric(), 
                         Pj = numeric(), 
                         SdPj = numeric(), 
                         Pa_hs = numeric(),
                         Pa_delta = numeric(),
                         Pj_hs = numeric(),
                         Pj_delta = numeric(),
                         F_low = numeric(), 
                         F_growth = numeric(), 
                         Uc = numeric(),
                         Hc = numeric (), 
                         Lbdmax = numeric(),
                         Th_ext = numeric(),
                         Scal = numeric(),
                         Time = numeric(),
                         Res = numeric(),
                         ResTh = numeric(),
                         Resfor = numeric(),  
                         SdTh = numeric(),
                         Scenario = numeric(),
                         Th_pa = numeric(),
                         H_min= numeric(),
                         Size = numeric(), 
                         Pred = numeric(),
                         Lbdfin = numeric(),
                         Pad = numeric(),
                         Pafin = numeric())
    
    
  }

} # End function Sim_ShortTerm
